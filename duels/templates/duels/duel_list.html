{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}–î—É—ç–ª–∏ | Magic RPG Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/vendor/css/duel.css">
{% endblock %}

{% block content %}
<div class="duels-container">
    <div class="duels-header reveal">
        <h1 class="text-gradient">–î—É—ç–ª–∏</h1>
        <p class="duels-description">–í—ã–∑—ã–≤–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –Ω–∞ –¥—É—ç–ª—å, —Å–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã!</p>
    </div>
    <div class="duels-actions">
        <a href="{% url 'duels:choose_opponent' %}" class="btn">–°–æ–∑–¥–∞—Ç—å –¥—É—ç–ª—å</a>
    </div>
    

    <div class="duels-sections">
        <!-- Active Duels -->
        <div class="active-duels card reveal">
            <div class="card-header">
                <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –¥—É—ç–ª–∏</h2>
            </div>
            <div class="card-body">
                {% if active_duels %}
                    {% for duel in active_duels %}
                    <div class="duel-card">
                        <div class="duel-header">
                            <h3 class="duel-title">–î—É—ç–ª—å —Å {{ duel.opponent.username }}</h3>
                            <span class="duel-status active">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                        </div>
                        <div class="duel-content">
                            <div class="duel-players">
                                <div class="player-info">
                                    <div class="player-avatar">
                                        {% if duel.challenger.profile.avatar %}
                                        <img src="{{ duel.challenger.profile.avatar.url|default:'/static/images/default-avatar.png' }}" alt="Avatar">
                                        {% else %}
                                        <img src="/static/images/default-avatar.png" alt="Avatar">
                                        {% endif %}
                                    </div>
                                    <div class="player-name">{{ duel.challenger.username }}</div>
                                </div>
                                <div class="vs-badge">VS</div>
                                <div class="player-info">
                                    <div class="player-avatar">
                                        {% if duel.opponent.profile.avatar %}
                                        <img src="{{ duel.opponent.profile.avatar.url|default:'/static/images/default_avatar.png' }}" alt="Avatar">
                                        {% else %}
                                        <img src="/static/images/default-avatar.png" alt="Avatar">
                                        {% endif %}
                                    </div>
                                    <div class="player-name">{{ duel.opponent.username }}</div>
                                </div>
                            </div>
                            <div class="duel-task">
                                <div class="task-name">{{ duel.task.title }}</div>
                                <div class="task-description">{{ duel.task.description|truncatewords:30 }}</div>
                            </div>
                            {% if duel.coins_stake > 0 %}
                            <div class="duel-stakes">
                                <div class="stake-item">
                                    <span class="stake-icon">üí∞</span>
                                    <span class="stake-value">{{ duel.coins_stake|multiply:2 }}</span>
                                </div>
                            </div>
                            {% endif %}
                            <div class="duel-progress">
                                <div class="progress-item">
                                    <span class="progress-status {% if duel.progress.first.completed %}completed{% else %}pending{% endif %}">
                                        {% if duel.progress.first.completed %}‚úì{% else %}‚è≥{% endif %}
                                    </span>
                                    <span>{{ duel.challenger.username }}</span>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-status {% if duel.progress.last.completed %}completed{% else %}pending{% endif %}">
                                        {% if duel.progress.last.completed %}‚úì{% else %}‚è≥{% endif %}
                                    </span>
                                    <span>{{ duel.opponent.username }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="duel-actions">
                            <a href="{% url 'duels:duel_detail' duel.id %}" class="btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                            {% if not duel.progress.first.completed %}
                            <a href="{% url 'duels:complete_duel_task' duel.id %}" class="btn btn-secondary">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥—É—ç–ª–µ–π. –í—ã–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∞ –Ω–∞ –¥—É—ç–ª—å!</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Pending Duels -->
        <div class="pending-duels card reveal">
            <div class="card-header">
                <h2>–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</h2>
            </div>
            <div class="card-body">
                {% if pending_duels %}
                    {% for duel in pending_duels %}
                    <div class="duel-card">
                        <div class="duel-header">
                            <h3 class="duel-title">–í—ã–∑–æ–≤ –æ—Ç {{ duel.challenger.username }}</h3>
                            <span class="duel-status pending">–û–∂–∏–¥–∞–µ—Ç</span>
                        </div>
                        <div class="duel-content">
                            <div class="duel-task">
                                <div class="task-name">{{ duel.task.title }}</div>
                                <div class="task-description">{{ duel.task.description|truncatewords:30 }}</div>
                            </div>
                            {% if duel.coins_stake > 0 %}
                            <div class="duel-stakes">
                                <div class="stake-item">
                                    <span class="stake-icon">üí∞</span>
                                    <span class="stake-value">{{ duel.coins_stake|multiply:2 }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="duel-actions">
                            <a href="{% url 'duels:accept_duel' duel.id %}" class="btn">–ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤</a>
                            <a href="{% url 'duels:decline_duel' duel.id %}" class="btn btn-secondary">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞ –¥—É—ç–ª–µ–π.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Completed Duels -->
        <div class="completed-duels card reveal">
            <div class="card-header">
                <h2>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –¥—É—ç–ª–∏</h2>
            </div>
            <div class="card-body">
                {% if completed_duels %}
                    {% for duel in completed_duels %}
                    <div class="duel-card">
                        <div class="duel-header">
                            <h3 class="duel-title">
                                {{ duel.challenger.username }} vs {{ duel.opponent.username }}
                            </h3>
                            <span class="duel-status completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                        </div>
                        <div class="duel-content">
                            <div class="duel-result">
                                <div class="result-text">
                                    –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <strong>{{ duel.winner.username }}</strong>
                                </div>
                                {% if duel.coins_stake > 0 %}
                                <div class="stake-result">
                                    –ù–∞–≥—Ä–∞–¥–∞: <span class="stake-value">{{ duel.coins_stake|multiply:2 }} üí∞</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="duel-actions">
                            <a href="{% url 'duels:duel_detail' duel.id %}" class="btn btn-secondary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –¥—É—ç–ª–µ–π.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}