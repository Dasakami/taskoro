{% extends 'base.html' %}
{% load static %}

{% block title %}Chat{% endblock %}

{% block extra_css %}
  <script>
    const username = "{{ username }}";
    const roomName = "{{ room_name }}";
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-background: #0a0a13;
      --color-background-secondary: #12122a;
      --color-text-primary: #e0e0ff;
      --color-text-secondary: #b3b3d9;
      --color-accent-primary: #6633ff;
      --color-accent-secondary: #ff3366;
      --color-accent-tertiary: #33ffcc;
      --color-success: #33ff99;
      --color-warning: #ffcc33;
      --color-error: #ff3333;
      --color-border: #333366;
      --gradient-primary: linear-gradient(135deg, #6633ff, #33ccff);
      --shadow-md: 0 0 16px rgba(102, 51, 255, 0.5);
      --radius-lg: 12px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="h-screen flex items-center justify-center bg-[color:var(--color-background)] text-[color:var(--color-text-primary)]">
  <div class="w-full max-w-2xl h-[80vh] rounded-[var(--radius-lg)] overflow-hidden shadow-lg shadow-[rgba(102,51,255,0.3)] bg-[color:var(--color-background-secondary)] flex flex-col">
    
    <div class="p-4 text-center font-bold text-lg bg-gradient-to-r from-[#6633ff] to-[#33ccff] text-white shadow">Чат</div>

    <!-- История сообщений -->
    <div id="chat-log" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
      {% for message in messages %}
        {% if message.sender.username == username %}
        <div class="text-right">
          <span class="inline-block px-4 py-2 rounded-[var(--radius-lg)] bg-[color:var(--color-accent-primary)] text-white shadow" style="max-width: 75%;">
            <strong>{{ message.sender.username }}:</strong> {{ message.content }}
          </span>
        </div>
        {% else %}
        <div class="text-left">
          <span class="inline-block px-4 py-2 rounded-[var(--radius-lg)] bg-[color:var(--color-border)] text-[color:var(--color-text-secondary)] shadow" style="max-width: 75%;">
            <strong>{{ message.sender.username }}:</strong> {{ message.content }}
          </span>
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Ввод сообщения -->
    <div class="p-4 border-t border-[color:var(--color-border)] bg-[color:var(--color-background)] flex gap-2">
      <input id="chat-message-input" type="text" placeholder="Введите сообщение..." class="flex-1 px-4 py-2 rounded-[var(--radius-lg)] bg-[color:var(--color-background-secondary)] text-[color:var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[color:var(--color-accent-primary)]" />
      <button id="chat-message-submit" class="px-4 py-2 bg-[color:var(--color-accent-primary)] text-white rounded-[var(--radius-lg)] hover:opacity-90 transition shadow-md">Отправить</button>
    </div>
  </div>
</div>

<script>
  const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${roomName}/`
  );

  const chatLog = document.getElementById('chat-log');
  const input = document.getElementById('chat-message-input');
  const button = document.getElementById('chat-message-submit');

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const isMine = data.sender === username;

    const msgDiv = document.createElement('div');
    msgDiv.className = isMine ? 'text-right' : 'text-left';

    const msgContent = document.createElement('span');
    msgContent.className = `inline-block px-4 py-2 rounded-[var(--radius-lg)] shadow ${isMine ? 'bg-[color:var(--color-accent-primary)] text-white' : 'bg-[color:var(--color-border)] text-[color:var(--color-text-secondary)]'}`;
    msgContent.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;

    msgDiv.appendChild(msgContent);
    chatLog.appendChild(msgDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  button.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    chatSocket.send(JSON.stringify({
      'message': message,
      'sender': username
    }));

    input.value = '';
  }
</script>
{% endblock %}
