{% extends "base.html" %}
{% load static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å | Magic RPG Tracker{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'vendor/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-header reveal">
  {# ‚Äî –§–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è #}
  <div class="profile-bg" style="background-image: url('{{ equipped_background.background_url|default:'/static/images/default_bg.jpg' }}')"></div>


  {# ‚Äî –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è #}
  <div class="profile-content-wrapper">
    {# ‚Äî –ê–≤–∞—Ç–∞—Ä —Å–µ–∫—Ü–∏—è #}
    <div class="profile-avatar-section">
      <div class="profile-frame frame-{{ equipped_frame.frame_style|default:"default" }}">
        {% if profile.avatar %}
          <img
            src="{{ profile.avatar.url }}"
            alt="Avatar"
            class="profile-avatar">
        {% else %}
          <div class="profile-avatar-placeholder">
            {{ profile.user.username|first|upper }}
          </div>
        {% endif %}
      </div>
      
      {% if equipped_title %}
        <div
          class="profile-title"
          style="color: {{ equipped_title.title_color|default:"#fff" }};">
          {{ equipped_title.name|default:"–ù–∞—á–∏–Ω–∞—é—â–∏–π –û—Ö–æ—Ç–Ω–∏–∫" }}
        </div>
      {% else %}
        <div class="profile-title">
          –ù–∞—á–∏–Ω–∞—é—â–∏–π –û—Ö–æ—Ç–Ω–∏–∫
        </div>
      {% endif %}
    </div>

    {# ‚Äî –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è #}
    <div class="profile-info">
      <h1 class="username-profile">{{ profile.user.username }}</h1>
      
      {# ‚Äî –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è #}
      {% if equipped_effect %}
      <div class="profile-effects">
        <div class="effect {{ equipped_effect.effect_class|default:"sparkle" }}"></div>
      </div>
      {% endif %}

      <div class="profile-stats">
        <div class="stat-item" style="animation-delay: 0.1s;">
          <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
          <div class="stat-value">{{ profile.level }}</div>
        </div>
        <div class="stat-item" style="animation-delay: 0.2s;">
          <div class="stat-label">–°–µ—Ä–∏—è</div>
          <div class="stat-value">{{ profile.streak }}</div>
        </div>
        <div class="stat-item" style="animation-delay: 0.3s;">
          <div class="stat-label">–ú–æ–Ω–µ—Ç—ã</div>
          <div class="stat-value">{{ profile.coins }}</div>
        </div>
        <div class="stat-item" style="animation-delay: 0.4s;">
          <div class="stat-label">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
          <div class="stat-value">{{ profile.gems }}</div>
        </div>
      </div>
    </div>

    {# ‚Äî –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ—Ñ–∏–ª—è #}
    {% if is_self %}
    <div class="profile-actions">
      <a href="{% url 'users:profile:edit_profile' %}" class="btn btn-primary">
        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      </a>
      <a href="{% url 'shop:user_inventory' %}" class="btn btn-secondary">
        <i class="fas fa-shopping-bag"></i> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div class="profile-content">
  {# ‚Äî –û–ø—ã—Ç –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å #}
  <div class="card reveal" style="animation-delay: 0.2s;">
    <div class="card-header">
      <h2><i class="fas fa-chart-line"></i> –û–ø—ã—Ç –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
    </div>
    <div class="card-body">
      <div class="exp-progress">
        <div class="progress">
          <div
            class="progress-bar"
            style="width: {{ profile.get_experience_percentage }}%"
            data-percentage="{{ profile.get_experience_percentage }}">
          </div>
        </div>
        <div class="exp-text">
          {{ profile.experience }} / {{ profile.experience_needed }} XP
        </div>
      </div>
      <div class="level-info">
        <i class="fas fa-info-circle"></i>
        –ù–∞–±–∏—Ä–∞–π—Ç–µ –æ–ø—ã—Ç, –≤—ã–ø–æ–ª–Ω—è—è –∑–∞–¥–∞—á–∏ –∏ —É—á–∞—Å—Ç–≤—É—è –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö!
      </div>
    </div>
  </div>

  {# ‚Äî –ê–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç—ã #}
  {% if active_boosts %}
  <div class="card reveal" style="animation-delay: 0.3s;">
    <div class="card-header">
      <h2><i class="fas fa-bolt"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ —É—Å–∏–ª–∏—Ç–µ–ª–∏</h2>
    </div>
    <div class="card-body">
      <div class="boosts-grid">
        {% for boost in active_boosts %}
        <div
          class="boost-item"
          data-remaining-seconds="{{ boost.remaining_seconds }}">
          <div class="boost-icon">
            {% if boost.item.image %}
              <img
                src="{{ boost.item.image.url }}"
                alt="{{ boost.item.name }}">
            {% else %}
              <i class="fas fa-bolt"></i>
            {% endif %}
          </div>
          <div class="boost-info">
            <div class="boost-name">{{ boost.item.name }}</div>
            <div class="boost-desc">√ó{{ boost.item.boost_multiplier }}</div>
            <div class="boost-time countdown" data-seconds="{{ boost.remaining_seconds }}"></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {# ‚Äî –ú–µ–¥–∞–ª–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è #}
  <div class="card reveal" style="animation-delay: 0.4s;">
    <div class="card-header">
      <h2><i class="fas fa-trophy"></i> –ú–µ–¥–∞–ª–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
    </div>
    <div class="card-body">
      {% if medals %}
      <div class="medals-grid">
        {% for medal in medals %}
        <div class="medal-item {{ medal.medal_type }}">
          <div class="medal-icon">üèÖ</div>
          <div class="medal-name">{{ medal.name }}</div>
          <div class="medal-desc">{{ medal.description }}</div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –º–µ–¥–∞–ª–µ–π. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –∑–∞–¥–∞—á–∏ –∏ —Ç—É—Ä–Ω–∏—Ä—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–∏ –ø–µ—Ä–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!</p>
      </div>
      {% endif %}
    </div>
  </div>

  {# ‚Äî –û —Å–µ–±–µ #}
  <div class="card reveal" style="animation-delay: 0.5s;">
    <div class="card-header">
      <h2><i class="fas fa-user"></i> –û —Å–µ–±–µ</h2>
    </div>
    <div class="card-body">
      {% if profile.bio %}
        <p class="bio-text">{{ profile.bio|linebreaks }}</p>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-pen" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
          <p>–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
  const revealElements = document.querySelectorAll('.reveal');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('revealed');
      }
    });
  }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
  
  revealElements.forEach(element => observer.observe(element));

  // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
  const progressBar = document.querySelector('.progress-bar');
  if (progressBar) {
    const percentage = progressBar.dataset.percentage;
    progressBar.style.width = '0%';
    setTimeout(() => {
      progressBar.style.width = percentage + '%';
    }, 500);
  }

  // –¢–∞–π–º–µ—Ä –¥–ª—è –±—É—Å—Ç–æ–≤
  function updateCountdowns() {
    document.querySelectorAll('.countdown').forEach(element => {
      let seconds = parseInt(element.dataset.seconds, 10);
      
      if (seconds <= 0) {
        element.textContent = '–ò—Å—Ç—ë–∫';
        element.style.color = '#f56565';
        return;
      }
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (hours > 0) {
        element.textContent = `${hours}—á ${minutes}–º ${remainingSeconds}—Å`;
      } else if (minutes > 0) {
        element.textContent = `${minutes}–º ${remainingSeconds}—Å`;
      } else {
        element.textContent = `${remainingSeconds}—Å`;
      }
      
      element.dataset.seconds = seconds - 1;
    });
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
  updateCountdowns();
  setInterval(updateCountdowns, 1000);

  // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('mouseenter', () => {
      card.style.transform = 'translateY(-5px) scale(1.02)';
    });
    
    card.addEventListener('mouseleave', () => {
      card.style.transform = 'translateY(0) scale(1)';
    });
  });

  // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  document.querySelectorAll('.stat-value').forEach((stat, index) => {
    const value = parseInt(stat.textContent);
    if (!isNaN(value)) {
      stat.textContent = '0';
      setTimeout(() => {
        animateNumber(stat, value, 1000);
      }, index * 100);
    }
  });

  function animateNumber(element, target, duration) {
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        current = target;
        clearInterval(timer);
      }
      element.textContent = Math.floor(current);
    }, 16);
  }

  // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
  function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-theme');
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }
});
</script>
{% endblock %}
